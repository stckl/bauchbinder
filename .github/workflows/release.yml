name: Build and Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-companion:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'
          cache-dependency-path: companion-module/package-lock.json

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Install Dependencies
        working-directory: companion-module
        run: npm ci

      - name: Set Companion Module Version
        working-directory: companion-module
        run: npm run set-version -- ${{ steps.version.outputs.VERSION }}

      - name: Build Companion Module
        working-directory: companion-module
        run: npm run package

      - name: Rename package with version
        working-directory: companion-module
        run: |
          mkdir -p pkg
          mv *.tgz pkg/bauchbinder-companion-v${{ steps.version.outputs.VERSION }}.tgz

      - name: Upload Companion Module to Release
        uses: softprops/action-gh-release@v2
        with:
          files: companion-module/pkg/bauchbinder-companion-v${{ steps.version.outputs.VERSION }}.tgz
          draft: true
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-mac:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Install Companion Dependencies
        working-directory: companion-module
        run: npm ci

      - name: Set Companion Module Version
        working-directory: companion-module
        run: npm run set-version -- ${{ steps.version.outputs.VERSION }}

      - name: Install App Dependencies
        run: npm ci

      - name: Setup DeckLink SDK
        if: ${{ secrets.DECKLINK_SDK_URL != '' }}
        env:
          DECKLINK_SDK_URL: ${{ secrets.DECKLINK_SDK_URL }}
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
        run: |
          if [ -n "$GITLAB_TOKEN" ]; then
            curl -L -H "PRIVATE-TOKEN: $GITLAB_TOKEN" -o /tmp/decklink-sdk.zip "$DECKLINK_SDK_URL"
          else
            curl -L -o /tmp/decklink-sdk.zip "$DECKLINK_SDK_URL"
          fi
          unzip -o /tmp/decklink-sdk.zip -d /tmp/decklink-sdk/
          cp /tmp/decklink-sdk/*/Mac/include/*.h src/native/sdk/ || cp /tmp/decklink-sdk/Mac/include/*.h src/native/sdk/
          cp /tmp/decklink-sdk/*/Mac/include/*.cpp src/native/sdk/ || cp /tmp/decklink-sdk/Mac/include/*.cpp src/native/sdk/
          ls -la src/native/sdk/

      - name: Build DeckLink Native Addon
        if: ${{ secrets.DECKLINK_SDK_URL != '' }}
        working-directory: src/native
        run: |
          npm install
          npx node-gyp rebuild
          npx @electron/rebuild -v $(node -p "require('../../package.json').devDependencies.electron.replace('^', '')") -a arm64
          ls -la build/Release/

      - name: Build Frontend
        run: npm run build

      - name: Build and Publish macOS App
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MACOS_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
          CSC_KEY_PASSWORD: "bauchbinder"
        run: |
          if [ -n "$MACOS_CERTIFICATE" ]; then
            echo "$MACOS_CERTIFICATE" | base64 --decode > certificate.p12
            export CSC_LINK=$(pwd)/certificate.p12
          fi
          npm run pack-macarm

  build-win:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Extract version from tag
        id: version
        shell: bash
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Install Companion Dependencies
        working-directory: companion-module
        run: npm ci

      - name: Set Companion Module Version
        working-directory: companion-module
        run: npm run set-version -- ${{ steps.version.outputs.VERSION }}

      - name: Install App Dependencies
        run: npm ci

      - name: Setup DeckLink SDK
        if: ${{ secrets.DECKLINK_SDK_URL != '' }}
        shell: pwsh
        env:
          DECKLINK_SDK_URL: ${{ secrets.DECKLINK_SDK_URL }}
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
        run: |
          $headers = @{}
          if ($env:GITLAB_TOKEN) {
            $headers["PRIVATE-TOKEN"] = $env:GITLAB_TOKEN
          }
          Invoke-WebRequest -Uri $env:DECKLINK_SDK_URL -OutFile "$env:TEMP\decklink-sdk.zip" -Headers $headers
          Expand-Archive -Path "$env:TEMP\decklink-sdk.zip" -DestinationPath "$env:TEMP\decklink-sdk" -Force
          $sdkRoot = Get-ChildItem "$env:TEMP\decklink-sdk" -Directory | Select-Object -First 1
          Copy-Item "$($sdkRoot.FullName)\Win\include\*" -Destination "src\native\sdk\" -Force
          Get-ChildItem "src\native\sdk"

      - name: Compile IDL with MIDL
        if: ${{ secrets.DECKLINK_SDK_URL != '' }}
        shell: cmd
        working-directory: src/native/sdk
        run: |
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
          midl /h DeckLinkAPI.h /iid DeckLinkAPI_i.c DeckLinkAPI.idl
          dir *.h

      - name: Build DeckLink Native Addon
        if: ${{ secrets.DECKLINK_SDK_URL != '' }}
        working-directory: src/native
        run: |
          npm install
          npx node-gyp rebuild
          npx @electron/rebuild -v $(node -p "require('../../package.json').devDependencies.electron.replace('^', '')") -a x64
          dir build\Release\

      - name: Build Frontend
        run: npm run build

      - name: Build and Publish Windows App
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npm run pack-win